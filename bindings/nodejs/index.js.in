const fs = require('fs');
const path = require('path');

var walkSync = function (dir, regexs) {
    var results = [];
    var dirs = fs.readdirSync(dir);

    for (var i = 0; i < dirs.length; i++) {
        var file = path.resolve(dir, dirs[i]);
        var stat = fs.statSync(file)

        if (stat && stat.isDirectory())
            results = results.concat(walkSync(file, regexs));
        else {
            for (var k = 0; k < regexs.length; k++) {
                if (file.match(regexs[k]) !== null) {
                    results.push({ path: file, mtime: stat.mtime });
                    break;
                }
            }
        }
    }
    return results;
};

var findModule = function(pattern) {
    var paths = walkSync(__dirname, [pattern]);

    if (paths.length == 0)
        throw new Error("Module not found. Has it been built?");
    else {
        paths.sort(function(a, b){
            /* sort according to modification time */
            return a.mtime > b.mtime ? -1 : (a.mtime == b.mtime ? 0 : 1);
        });
        return paths[0].path;
    }
}

module.exports = require(findModule(/^.*[\\/]binding\.node$/));
